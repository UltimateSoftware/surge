<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Command Side Usage · Surge</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='surge-docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/warnOldVersion.js"></script>
<script type="text/javascript" src="js/groups.js"></script>
<script type="text/javascript" src="js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>Surge
</a>
<div class="version-number">
0.0.0+1-48937fee*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="command-usage.html" class="active page">Command Side Usage</a></li>
  <li><a href="tracing-usage.html" class="page">Open Telemetry Integration</a></li>
  <li><a href="repository-tour.html" class="page">Repository Tour</a></li>
  <li><a href="utilities.html" class="page">Utilities</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html">Surge</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>Surge
</a>
<div class="version-number">
0.0.0+1-48937fee*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="overview.html" class="page">Overview</a></li>
  <li><a href="command-usage.html" class="active page">Command Side Usage</a></li>
  <li><a href="tracing-usage.html" class="page">Open Telemetry Integration</a></li>
  <li><a href="repository-tour.html" class="page">Repository Tour</a></li>
  <li><a href="utilities.html" class="page">Utilities</a></li>
  <li><a href="testing.html" class="page">Testing</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">Surge</a></li>
  <li>Command Side Usage</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#command-side-usage" name="command-side-usage" class="anchor"><span class="anchor-link"></span></a>Command Side Usage</h1>
<p>Surge provides an engine that must be configured with domain logic. It uses this domain logic under the hood to determine what events should be emitted based on a command and how to update the state of an aggregate based on those events. This page describes how to configure, create, and interact with a Surge command engine.</p>
<h2><a href="#module-info" name="module-info" class="anchor"><span class="anchor-link"></span></a>Module Info</h2><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val SurgeVersion = "0.0.0+1-48937fee-SNAPSHOT"
libraryDependencies += "com.ukg" %% "surge-engine-command-scaladsl" % SurgeVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;surge.version&gt;0.0.0+1-48937fee-SNAPSHOT&lt;/surge.version&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;com.ukg&lt;/groupId&gt;
    &lt;artifactId&gt;surge-engine-command-scaladsl_${scala.binary.version}&lt;/artifactId&gt;
    &lt;version&gt;${surge.version}&lt;/version&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  SurgeVersion: "0.0.0+1-48937fee-SNAPSHOT",
  ScalaBinary: "2.13"
]
dependencies {
  implementation "com.ukg:surge-engine-command-scaladsl_${versions.ScalaBinary}:${versions.SurgeVersion}"
}</code></pre></dd></dl>
<h2><a href="#domain-logic" name="domain-logic" class="anchor"><span class="anchor-link"></span></a>Domain Logic</h2>
<h3><a href="#aggregates" name="aggregates" class="anchor"><span class="anchor-link"></span></a>Aggregates</h3>
<p>An aggregate type is the base type for an instance of the Surge engine. Multiple Surge engines can be run within a service, but one instance of the engine should map to exactly one type of aggregate. Aggregates should be simple data classes used to maintain any context/state needed to process incoming commands.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Please, make sure your Aggregate inherits <code>java.io.Serializable</code> to guarantee it gets serialized and deserialized correctly.</p></div>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandModel.scala#L16-L19" target="_blank" title="Go to snippet source">source</a><code class="language-scala">object BankAccount {
  implicit val format: Format[BankAccount] = Json.format
}
case class BankAccount(accountNumber: UUID, accountOwner: String, securityCode: String, balance: Double)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/account/BankAccount.java#L11-L41" target="_blank" title="Go to snippet source">source</a><code class="language-java">@JsonSerialize
@JsonAutoDetect(fieldVisibility = JsonAutoDetect.Visibility.ANY)
public class BankAccount {
    private final UUID accountNumber;
    private final String accountOwner;
    private final String securityCode;
    private double balance;

    public BankAccount(UUID accountNumber, String accountOwner, String securityCode, double balance) {
        this.accountNumber = accountNumber;
        this.accountOwner = accountOwner;
        this.securityCode = securityCode;
        this.balance = balance;
    }

    public UUID getAccountNumber() {
        return accountNumber;
    }

    public String getAccountOwner() {
        return accountOwner;
    }

    public String getSecurityCode() {
        return securityCode;
    }

    public double getBalance() {
        return balance;
    }
}</code></pre></dd>
</dl>
<h3><a href="#commands" name="commands" class="anchor"><span class="anchor-link"></span></a>Commands</h3>
<p>Commands are data classes intended to handled by an instance of an aggregate to emit events or reject the command and return an error to the end user. Surge strongly types a command engine on an aggregate type, command type, and event type, so any commands you intend to send to an aggregate must inherit from the same base class/interface.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandModel.scala#L23-L28" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait BankAccountCommand {
  def accountNumber: UUID
}
case class CreateAccount(accountNumber: UUID, accountOwner: String, securityCode: String, initialBalance: Double) extends BankAccountCommand
case class CreditAccount(accountNumber: UUID, amount: Double) extends BankAccountCommand
case class DebitAccount(accountNumber: UUID, amount: Double) extends BankAccountCommand</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/command/BankAccountCommand.java#L8-L10" target="_blank" title="Go to snippet source">source</a><code class="language-java">public interface BankAccountCommand {
    UUID getAccountNumber();
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/command/CreateAccount.java#L7-L36" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class CreateAccount implements BankAccountCommand {
    private final UUID accountNumber;
    private final String accountOwner;
    private final double balance;
    private final String securityCode;

    public CreateAccount(UUID accountNumber, String accountOwner, String securityCode, double initialBalance) {
        this.accountNumber = accountNumber;
        this.accountOwner = accountOwner;
        this.securityCode = securityCode;
        this.balance = initialBalance;
    }

    @Override
    public UUID getAccountNumber() {
        return accountNumber;
    }

    public String getAccountOwner() {
        return accountOwner;
    }

    public double getBalance() {
        return balance;
    }

    public String getSecurityCode() {
        return securityCode;
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/command/CreditAccount.java#L8-L23" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class CreditAccount implements BankAccountCommand {
    private final UUID accountNumber;
    private final double amount;
    public CreditAccount(UUID accountNumber, double amount) {
        this.accountNumber = accountNumber;
        this.amount = amount;
    }
    @Override
    public UUID getAccountNumber() {
        return accountNumber;
    }

    public double getAmount() {
        return amount;
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/command/DebitAccount.java#L8-L24" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class DebitAccount implements BankAccountCommand {
    private final UUID accountNumber;
    private final double amount;
    public DebitAccount(UUID accountNumber, double amount) {
        this.accountNumber = accountNumber;
        this.amount = amount;
    }

    @Override
    public UUID getAccountNumber() {
        return accountNumber;
    }

    public double getAmount() {
        return amount;
    }
}</code></pre></dd>
</dl>
<h3><a href="#events" name="events" class="anchor"><span class="anchor-link"></span></a>Events</h3>
<p>Events are the result of successfully applied commands.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandModel.scala#L32-L48" target="_blank" title="Go to snippet source">source</a><code class="language-scala">sealed trait BankAccountEvent {
  def accountNumber: UUID
  def toJson: JsValue
}
object BankAccountCreated {
  implicit val format: Format[BankAccountCreated] = Json.format
}
case class BankAccountCreated(accountNumber: UUID, accountOwner: String, securityCode: String, balance: Double) extends BankAccountEvent {
  override def toJson: JsValue = Json.toJson(this)
}

object BankAccountUpdated {
  implicit val format: Format[BankAccountUpdated] = Json.format
}
case class BankAccountUpdated(accountNumber: UUID, newBalance: Double) extends BankAccountEvent {
  override def toJson: JsValue = Json.toJson(this)
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/event/BankAccountEvent.java#L10-L19" target="_blank" title="Go to snippet source">source</a><code class="language-java">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME,
        property = &quot;name&quot;)
@JsonSubTypes({
        @JsonSubTypes.Type(value = BankAccountCreated.class, name = &quot;BankAccountCreated&quot;),
        @JsonSubTypes.Type(value = BankAccountUpdated.class, name = &quot;BankAccountUpdated&quot;),
})
public interface BankAccountEvent {

    UUID getAccountNumber();
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/event/BankAccountCreated.java#L12-L46" target="_blank" title="Go to snippet source">source</a><code class="language-java">@JsonSerialize
@JsonTypeName(&quot;BankAccountCreated&quot;)
@JsonAutoDetect(fieldVisibility = JsonAutoDetect.Visibility.ANY)
public class BankAccountCreated implements BankAccountEvent {

    private final UUID accountNumber;
    private final String accountOwner;
    private final String securityCode;
    private final double balance;

    public BankAccountCreated(UUID accountNumber, String accountOwner, String securityCode,
                              double balance) {
        this.accountNumber = accountNumber;
        this.accountOwner = accountOwner;
        this.securityCode = securityCode;
        this.balance = balance;
    }

    @Override
    public UUID getAccountNumber() {
        return accountNumber;
    }

    public String getAccountOwner() {
        return accountOwner;
    }

    public String getSecurityCode() {
        return securityCode;
    }

    public double getBalance() {
        return balance;
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/event/BankAccountUpdated.java#L11-L32" target="_blank" title="Go to snippet source">source</a><code class="language-java">@JsonSerialize
@JsonTypeName(&quot;BankAccountUpdated&quot;)
@JsonAutoDetect(fieldVisibility = JsonAutoDetect.Visibility.ANY)
public class BankAccountUpdated implements BankAccountEvent {

    public double amount;
    public UUID accountNumber;

    public BankAccountUpdated(UUID accountNumber, double amount) {
        this.amount = amount;
        this.accountNumber = accountNumber;
    }

    @Override
    public UUID getAccountNumber() {
        return accountNumber;
    }

    public double getAmount() {
        return amount;
    }
}</code></pre></dd>
</dl>
<h2><a href="#surge-configuration" name="surge-configuration" class="anchor"><span class="anchor-link"></span></a>Surge Configuration</h2>
<p>The configuration of a Surge engine is done by implementing a command model interface with your particular domain logic and a Surge model interface with Kafka topic configuration.</p>
<p>The command model interface is a way to express the way a domain should handle commands and process events for a particular instance of an aggregate. This is the main wiring of domain logic that Surge leverages. It is strongly typed on aggregate Id type, aggregate, base command, and base event type.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandModel.scala#L52-L87" target="_blank" title="Go to snippet source">source</a><code class="language-scala">object BankAccountCommandModel extends AggregateCommandModel[BankAccount, BankAccountCommand, BankAccountEvent] {
  override def processCommand(aggregate: Option[BankAccount], command: BankAccountCommand): Try[Seq[BankAccountEvent]] = {
    command match {
      case create: CreateAccount =&gt;
        if (aggregate.isDefined) {
          // Aggregate already exists - no need to recreate
          Success(Seq.empty)
        } else {
          Success(Seq(BankAccountCreated(create.accountNumber, create.accountOwner, create.securityCode, create.initialBalance)))
        }
      case credit: CreditAccount =&gt;
        aggregate
          .map { existing =&gt;
            Success(Seq(BankAccountUpdated(existing.accountNumber, existing.balance + credit.amount)))
          }
          .getOrElse(Failure(new AccountDoesNotExistException(command.accountNumber)))
      case debit: DebitAccount =&gt;
        aggregate
          .map { existing =&gt;
            if (existing.balance &gt;= debit.amount) {
              Success(Seq(BankAccountUpdated(existing.accountNumber, existing.balance - debit.amount)))
            } else {
              Failure(new InsufficientFundsException(existing.accountNumber))
            }
          }
          .getOrElse(Failure(new AccountDoesNotExistException(command.accountNumber)))
    }
  }

  override def handleEvent(aggregate: Option[BankAccount], event: BankAccountEvent): Option[BankAccount] = {
    event match {
      case create: BankAccountCreated  =&gt; Some(BankAccount(create.accountNumber, create.accountOwner, create.securityCode, create.balance))
      case updated: BankAccountUpdated =&gt; aggregate.map(_.copy(balance = updated.newBalance))
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/BankAccountCommandModel.java#L20-L91" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class BankAccountCommandModel implements AggregateCommandModel&lt;BankAccount, BankAccountCommand, BankAccountEvent&gt; {

    @Override
    public List&lt;BankAccountEvent&gt; processCommand(Optional&lt;BankAccount&gt; aggregate, BankAccountCommand command) {

        // users can feel free to use vavr pattern matching as an alternative to instanceOf.
        if (command instanceof CreateAccount) {
            CreateAccount createAccount = (CreateAccount) command;
            if (aggregate.isPresent()) {
                return new ArrayList&lt;&gt;();
            } else {
                BankAccountCreated bankAccountCreated = new BankAccountCreated(createAccount.getAccountNumber(),
                        createAccount.getAccountOwner()
                        , createAccount.getSecurityCode()
                        , createAccount.getBalance());
                return Collections.singletonList(bankAccountCreated);

            }
        }
        if (command instanceof CreditAccount) {
            CreditAccount creditAccount = (CreditAccount) command;

            if (aggregate.isPresent()) {
                BankAccount bankAccount = aggregate.get();
                BankAccountUpdated bankAccountUpdated = new BankAccountUpdated(creditAccount.getAccountNumber()
                        , bankAccount.getBalance() + creditAccount.getAmount());
                return Collections.singletonList(bankAccountUpdated);

            } else {
                throw new RuntimeException(&quot;Account does not exist&quot;);
            }
        }
        if (command instanceof DebitAccount) {
            DebitAccount debitAccount = (DebitAccount) command;
            if (aggregate.isPresent()) {
                BankAccount bankAccount = aggregate.get();
                if (bankAccount.getBalance() &gt;= debitAccount.getAmount()) {
                    BankAccountUpdated bankAccountUpdated = new BankAccountUpdated(bankAccount.getAccountNumber(),
                            bankAccount.getBalance() - debitAccount.getAmount());
                    return Collections.singletonList(bankAccountUpdated);

                } else {
                    throw new RuntimeException(&quot;Insufficient funds&quot;);
                }
            } else {
                throw new RuntimeException(&quot;Account does not exist&quot;);
            }
        }
        throw new RuntimeException(&quot;Unhandled command&quot;);
    }

    @Override
    public Optional&lt;BankAccount&gt; handleEvent(Optional&lt;BankAccount&gt; aggregate, BankAccountEvent event) {

        // users can feel free to use vavr pattern matching as an alternative to instanceOf.
        if (event instanceof BankAccountCreated) {
            BankAccountCreated bankAccountCreated = (BankAccountCreated)event;
            Optional&lt;BankAccount&gt; bankAccount;
            bankAccount = Optional.of(new BankAccount(event.getAccountNumber(), bankAccountCreated.getAccountOwner(),
                    bankAccountCreated.getSecurityCode(), bankAccountCreated.getBalance()));
            return bankAccount;
        }
        if (event instanceof BankAccountUpdated) {
            BankAccountUpdated bankAccountUpdated = (BankAccountUpdated)event;

            return aggregate.map((item) -&gt; new BankAccount(item.getAccountNumber(), item.getAccountOwner()
                    , item.getSecurityCode(), bankAccountUpdated.getAmount()));
        }
        throw new RuntimeException(&quot;Unhandled event&quot;);
    }

}</code></pre></dd>
</dl>
<p>The command model gets wired into Surge through a Surge model, which additionally includes the topics to publish to.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountSurgeModel.scala#L13-L33" target="_blank" title="Go to snippet source">source</a><code class="language-scala">object BankAccountSurgeModel extends SurgeCommandBusinessLogic[UUID, BankAccount, BankAccountCommand, BankAccountEvent] {
  override def commandModel: AggregateCommandModel[BankAccount, BankAccountCommand, BankAccountEvent] = BankAccountCommandModel

  override def aggregateName: String = &quot;bank-account&quot;

  override def stateTopic: KafkaTopic = KafkaTopic(&quot;bank-account-state&quot;)

  override def eventsTopic: KafkaTopic = KafkaTopic(&quot;bank-account-events&quot;)

  override def aggregateReadFormatting: SurgeAggregateReadFormatting[BankAccount] = { (bytes: Array[Byte]) =&gt;
    Json.parse(bytes).asOpt[BankAccount]
  }

  override def aggregateWriteFormatting: SurgeAggregateWriteFormatting[BankAccount] = (agg: BankAccount) =&gt; {
    SerializedAggregate(Json.toJson(agg).toString().getBytes(), Map(&quot;aggregate_id&quot; -&gt; agg.accountNumber.toString))
  }

  override def eventWriteFormatting: SurgeEventWriteFormatting[BankAccountEvent] = (evt: BankAccountEvent) =&gt; {
    SerializedMessage(evt.accountNumber.toString, Json.toJson(evt)(Json.format[BankAccountEvent]).toString().getBytes())
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/BankAccountSurgeModel.java#L20-L56" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class BankAccountSurgeModel extends SurgeCommandBusinessLogic&lt;UUID, BankAccount, BankAccountCommand,
        BankAccountEvent&gt; {
    @Override
    public AggregateCommandModel&lt;BankAccount, BankAccountCommand, BankAccountEvent&gt; commandModel() {
        return new BankAccountCommandModel();
    }

    @Override
    public String aggregateName() {
        return &quot;bank-account&quot;;
    }

    @Override
    public KafkaTopic stateTopic() {
        return new KafkaTopic(&quot;bank-account-state&quot;);
    }

    @Override
    public KafkaTopic eventsTopic() {
        return new KafkaTopic(&quot;bank-account-events&quot;);
    }

    @Override
    public SurgeAggregateReadFormatting&lt;BankAccount&gt; aggregateReadFormatting() {
        return new SurgeAggregateReadFormattingBankAccount();
    }

    @Override
    public SurgeEventWriteFormatting&lt;BankAccountEvent&gt; eventWriteFormatting() {
        return new SurgeEventWriteFormattingBankEvent();
    }

    @Override
    public SurgeAggregateWriteFormatting&lt;BankAccount&gt; aggregateWriteFormatting() {
        return new SurgeAggregateWriteFormattingBankAccount();
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/format/SurgeAggregateReadFormattingBankAccount.java#L13-L23" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class SurgeAggregateReadFormattingBankAccount implements SurgeAggregateReadFormatting&lt;BankAccount&gt; {
    @Override
    public Option&lt;BankAccount&gt; readState(byte[] bytes) {
        ObjectMapper objectMapper = new ObjectMapper();
        try {
            return Option.apply(objectMapper.readValue(bytes, BankAccount.class));
        } catch (IOException e) {
            return Option.empty();
        }
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/format/SurgeAggregateWriteFormattingBankAccount.java#L12-L24" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class SurgeAggregateWriteFormattingBankAccount implements SurgeAggregateWriteFormatting&lt;BankAccount&gt; {
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public SerializedAggregate writeState(BankAccount bankAccount) {
        try {
            byte[] bankAccountBytes = objectMapper.writeValueAsBytes(bankAccount);
            return SerializedAggregate.create(bankAccountBytes);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}</code></pre>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/format/SurgeEventWriteFormattingBankEvent.java#L11-L23" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class SurgeEventWriteFormattingBankEvent implements SurgeEventWriteFormatting&lt;BankAccountEvent&gt; {
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public SerializedMessage writeEvent(BankAccountEvent evt) {
        try {
            return SerializedMessage.create(evt.getAccountNumber().toString(), objectMapper.writeValueAsBytes(evt));
        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }
}</code></pre></dd>
</dl>
<h2><a href="#creating-and-interacting-with-the-engine" name="creating-and-interacting-with-the-engine" class="anchor"><span class="anchor-link"></span></a>Creating and interacting with the engine</h2>
<p>Once the configuration is defined you can inject it into a Surge engine:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountEngine.scala#L10-L16" target="_blank" title="Go to snippet source">source</a><code class="language-scala">object BankAccountEngine {
  lazy val surgeEngine: SurgeCommand[UUID, BankAccount, BankAccountCommand, BankAccountEvent] = {
    val engine = SurgeCommand(BankAccountSurgeModel)
    engine.start()
    engine
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/Main.java#L27-L30" target="_blank" title="Go to snippet source">source</a><code class="language-java">BankAccountSurgeModel bankAccountSurgeModel = new BankAccountSurgeModel();
SurgeCommand&lt;UUID, BankAccount, BankAccountCommand, BankAccountEvent&gt; surgeCommand =
        new SurgeCommandBuilder().withBusinessLogic(bankAccountSurgeModel).build();
surgeCommand.start();</code></pre></dd>
</dl>
<p>You can interact with the running engine via two main methods, <code>sendCommand</code> for sending commands and <code>getState</code> for fetching state:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandEngineSpec.scala#L43-L60" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val accountNumber = UUID.randomUUID()
val createAccount = CreateAccount(accountNumber, &quot;Jane Doe&quot;, &quot;1234&quot;, 1000.0)

val createdAccount: Future[Option[BankAccount]] = BankAccountEngine.surgeEngine.aggregateFor(accountNumber).sendCommand(createAccount).map {
  case CommandSuccess(aggregateState) =&gt; aggregateState
  case CommandFailure(reason)         =&gt; throw reason
}
val creditAccount = CreditAccount(accountNumber, 100.0)

val creditedAccount: Future[Option[BankAccount]] = BankAccountEngine.surgeEngine.aggregateFor(accountNumber).sendCommand(creditAccount).map {
  case CommandSuccess(aggregateState) =&gt; aggregateState
  case CommandFailure(reason)         =&gt; throw reason
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/Main.java#L34-L54" target="_blank" title="Go to snippet source">source</a><code class="language-java">UUID accountNumber = UUID.randomUUID();
logger.info(&quot;Account number is: {}&quot;, accountNumber);
CreateAccount createAccount = new CreateAccount(accountNumber, &quot;Jane Doe&quot;,
        &quot;1234&quot;, 1000.0);

CompletionStage&lt;CommandResult&lt;BankAccount&gt;&gt; completionStageCreateAccount =
        surgeCommand.aggregateFor(accountNumber).sendCommand(createAccount);

completionStageCreateAccount.whenComplete((CommandResult&lt;BankAccount&gt; result, Throwable ex) -&gt; {
    if (ex != null) {
        ex.printStackTrace();
    } else {
        if (result instanceof CommandSuccess) {
            CommandSuccess&lt;BankAccount&gt; commandSuccess = (CommandSuccess&lt;BankAccount&gt;)result;
            logger.info(&quot;Aggregate state is: {} &quot;, commandSuccess.aggregateState());
        } else if (result instanceof CommandFailure) {
            CommandFailure&lt;BankAccount&gt; commandFailure = (CommandFailure&lt;BankAccount&gt;)result;
            commandFailure.reason().printStackTrace();
        }
    }
});</code></pre></dd>
</dl>
<p>The <code>sendCommand</code> method will return a <code>CommandSuccess</code> if the command was processed successfully, even if no events are emitted or a <code>CommandFailure</code> wrapping any exception thrown as part of the command processing logic if one is thrown.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/scala/docs/command/BankAccountCommandEngineSpec.scala#L65" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val currentState: Future[Option[BankAccount]] = BankAccountEngine.surgeEngine.aggregateFor(accountNumber).getState</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/test/java/javadocs/commandapp/Main.java#L58-L66" target="_blank" title="Go to snippet source">source</a><code class="language-java">CompletionStage&lt;Optional&lt;BankAccount&gt;&gt; currentState = surgeCommand.aggregateFor(accountNumber).getState();
currentState.whenComplete((bankAccount, throwable) -&gt;
{
    if (throwable != null) {
        throwable.printStackTrace();
    } else {
        logger.info(&quot;Current state is: {}&quot;, bankAccount);
    }
});</code></pre></dd>
</dl>
<p>The <code>getState</code> method will return the current state of the given aggregate if it exists.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/UltimateSoftware/surge/tree/master/modules/surge-docs/src/main/paradox/command-usage.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="tracing-usage.html">Open Telemetry Integration</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="command-usage.html#command-side-usage" class="header">Command Side Usage</a>
  <ul>
    <li><a href="command-usage.html#module-info" class="header">Module Info</a></li>
    <li><a href="command-usage.html#domain-logic" class="header">Domain Logic</a></li>
    <li><a href="command-usage.html#surge-configuration" class="header">Surge Configuration</a></li>
    <li><a href="command-usage.html#creating-and-interacting-with-the-engine" class="header">Creating and interacting with the engine</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2022</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.0.0+1-48937fee-SNAPSHOT', '')});</script>


</html>
